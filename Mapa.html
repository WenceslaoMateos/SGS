<!DOCTYPE html>
<html>
  <head>
    <title>Visor de Campa√±as</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.5.0/css/ol.css" type="text/css">
     <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.5.0/build/ol.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <style>
      .ol-popup{
        position: absolute;
        background-color: white;
        -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
        filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
        min-width: 280px;
      }
      .ol-popup:after, .ol-popup:before{
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }
      .ol-popup:after{
        border-top-color: rgb(255, 255, 255);
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
      }
      .ol-popup:before{
        border-top-color: #ffffff;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
      }
      .ol-popup-closer{
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
      }
      .ol-popup-closer:after{
        content: "X";
      }
      </style>
    </head>
    <body>          
          <div class="collapse" id="navbarToggleExternalContent">
              <div class="bg-dark p-4">
                <h4 class="text-white">Aca van a ir las opciones</h4>
                <span class="text-muted">Se supone que se van a ver a la izquierda.</span>
              </div>
            </div>
            <nav class="navbar navbar-dark bg-dark">
              <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
            </nav>

      <div class="container">
      <div id="map" class="map"></div>
      <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
      </div>
      <script>
        var container = document.getElementById('popup');
        var content = document.getElementById('popup-content');
        var closer = document.getElementById('popup-closer');

        var overlay = new ol.Overlay({
          element: container,
          autoPan: true,
          autoPanAnimation: {duration: 250}
        });

        var openStreetMap = new ol.layer.Tile({
          source: new ol.source.OSM({
            attributions: [
              'All maps <a href="http://www.openstreetmap.org/">OpenStreetMap</a>',
              ol.source.OSM.ATTRIBUTION
            ],
            opaque: false,
            url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
          })
        });

        var openSeaMapLayer = new ol.layer.Tile({
          source: new ol.source.OSM({
            attributions: [
              'All maps <a href="http://www.openseamap.org/">OpenSeaMap</a>',
              ol.source.OSM.ATTRIBUTION
            ],
            opaque: false,
            url: 'https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png'
          })
        });

        var vector = new ol.layer.Vector({
          style: styleFunction
        });

        var map = new ol.Map({
          layers: [openStreetMap , openSeaMapLayer , vector],
          target: 'map',
          overlays: [overlay],
          view: new ol.View({
            maxZoom: 18,
            center: ol.proj.transform([8.5550875,53.566916333333], 'EPSG:4326', 'EPSG:3857'),
            zoom: 2
          })
        });

        closer.onclick = function(){
          overlay.setPosition(undefined);
          closer.blur();
          return false;
        };

        function hacerCuandoSeleccione(that){
          if (that.selected.length >= 1){
            var geometria = that.selected[0].getGeometry();
            var posicion = geometria.getFirstCoordinate();  
            var propiedades = that.selected[0].getProperties()
            overlay.setPosition(posicion);
            content.innerHTML = "";
            var claves = Object.keys(propiedades);
            claves = claves.filter(item => item != "geometry");
            claves = claves.filter(item => item != "type");
            claves = claves.filter(item => item != "styleUrl");
            claves.forEach(function(clave){
              if (propiedades[clave] != ""){
                content.innerHTML += clave + ": " + propiedades[clave] + "<br>";
              }
            });
          }
        }
        
        function cuadro(){
          var extent = map.getView().calculateExtent(map.getSize());
          var bottomLeft = ol.proj.transform(ol.extent.getBottomLeft(extent),'EPSG:3857', 'EPSG:4326');
          var topRight = ol.proj.transform(ol.extent.getTopRight(extent),'EPSG:3857', 'EPSG:4326');
          var arr = {
            'x1':bottomLeft[0],
            'x2':topRight[0],
            'y2':topRight[1],
            'y1':bottomLeft[1]
          };
          return arr;
        }

        var styleFunction = function(feature) {
          var propiedades = feature.getProperties();
          var rotation = (propiedades['angulo'] * Math.PI) / 180;
          if (propiedades['type']==='point' && propiedades['angulo']!= ""){
            style = new ol.style.Style({
              image: new ol.style.Icon({
                src: './images/arrow.png',
                opacity: 1,
                scale: 0.1,
                rotateWithView: true,
                rotation: rotation
              })
            });
          }
          else{
            style = new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: '#777777',
                width: 2
              })
            })
          }
          return [style]
        };  

        function changeVector(){
          var cuadrado = cuadro();
          vector.setSource(new ol.source.Vector({
            url: "buscaDatosDB.php?x1=" + cuadrado['x1'] + '&x2=' + cuadrado['x2'] + '&y2=' + cuadrado['y2'] + '&y1=' + cuadrado['y1'],
            format: new ol.format.KML({extractStyles: false})
          }));
          vector.setStyle(styleFunction);
        };

        map.on('moveend', changeVector);

        var select = new ol.interaction.Select({condition: ol.events.condition.click});
        map.addInteraction(select);
        select.on('select', hacerCuandoSeleccione,this);
    </script>
    </div>
  </body>
</html>